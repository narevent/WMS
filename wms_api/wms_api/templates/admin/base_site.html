{% extends "admin/base.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof tinymce !== 'undefined') {
                tinymce.on('AddEditor', function(e) {
                    console.log('TinyMCE editor added, setting up FileBrowser integration');
                    e.editor.on('init', function() {
                        setupFileBrowserIntegration(e.editor);
                    });
                });
            }
        });

        function setupFileBrowserIntegration(editor) {
            console.log('Setting up FileBrowser integration for editor:', editor.id);
            editor.ui.registry.addButton('customimage', {
                icon: 'image',
                tooltip: 'Insert/edit image',
                onAction: function() {
                    openFileBrowser('image', function(url) {
                        editor.insertContent('<img src="' + url + '" alt="" />');
                    });
                }
            });

            editor.ui.registry.addButton('customlink', {
                icon: 'link', 
                tooltip: 'Insert/edit link',
                onAction: function() {
                    openFileBrowser('file', function(url) {
                        var selectedText = editor.selection.getContent({format: 'text'});
                        var linkText = selectedText || 'Link';
                        editor.insertContent('<a href="' + url + '">' + linkText + '</a>');
                    });
                }
            });
        }

        function openFileBrowser(type, callback) {
            var cmsURL = '/admin/filebrowser/browse/?pop=2';
            if (type === 'image') {
                cmsURL += '&type=Image';
            } else {
                cmsURL += '&type=Document';
            }
            
            console.log('Opening FileBrowser:', cmsURL);
            var popup = window.open(
                cmsURL,
                'filebrowser',
                'width=980,height=500,scrollbars=yes,resizable=yes'
            );
            
            var checkClosed = setInterval(function() {
                if (popup.closed) {
                    clearInterval(checkClosed);
                }
            }, 1000);
        }
    </script>
{% endblock %}